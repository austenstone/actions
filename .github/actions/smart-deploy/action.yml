name: 'Smart Deploy'
description: 'Intelligent deployment with health checks and rollback capability'
author: 'GitHub Actions Demo'

inputs:
  environment:
    description: 'Target environment (staging, production)'
    required: true
  health_check_url:
    description: 'Health check endpoint URL'
    required: true
  rollback_on_failure:
    description: 'Automatically rollback on deployment failure'
    required: false
    default: 'true'
  timeout_minutes:
    description: 'Deployment timeout in minutes'
    required: false
    default: '10'
  notification_webhook:
    description: 'Webhook URL for deployment notifications'
    required: false

outputs:
  deployment_id:
    description: 'Unique deployment identifier'
    value: ${{ steps.deploy.outputs.deployment_id }}
  deployment_url:
    description: 'URL of the deployed application'
    value: ${{ steps.deploy.outputs.deployment_url }}
  deployment_status:
    description: 'Final deployment status'
    value: ${{ steps.finalize.outputs.status }}

runs:
  using: 'composite'
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        echo "ğŸ” Validating deployment inputs..."
        
        if [[ -z "${{ inputs.environment }}" ]]; then
          echo "âŒ Environment is required"
          exit 1
        fi
        
        if [[ -z "${{ inputs.health_check_url }}" ]]; then
          echo "âŒ Health check URL is required"
          exit 1
        fi
        
        if [[ "${{ inputs.environment }}" != "staging" && "${{ inputs.environment }}" != "production" ]]; then
          echo "âŒ Environment must be 'staging' or 'production'"
          exit 1
        fi
        
        echo "âœ… Input validation passed"
        
    - name: Pre-deployment checks
      shell: bash
      run: |
        echo "ğŸ” Running pre-deployment checks..."
        
        # Check if target environment is healthy
        if curl -f -s "${{ inputs.health_check_url }}" > /dev/null; then
          echo "âœ… Target environment is healthy"
        else
          echo "âš ï¸ Target environment health check failed (this is expected for new deployments)"
        fi
        
        # Check deployment prerequisites
        echo "âœ… Pre-deployment checks completed"
        
    - name: Deploy application
      id: deploy
      shell: bash
      run: |
        echo "ğŸš€ Starting deployment to ${{ inputs.environment }}..."
        
        # Generate unique deployment ID
        DEPLOYMENT_ID="deploy-$(date +%s)-${{ github.run_id }}"
        echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
        
        # Set deployment URL based on environment
        if [[ "${{ inputs.environment }}" == "production" ]]; then
          DEPLOYMENT_URL="https://production.example.com"
        else
          DEPLOYMENT_URL="https://staging.example.com"
        fi
        echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
        
        # Simulate deployment process
        echo "ğŸ“¦ Deploying application..."
        sleep 5
        
        # Simulate potential deployment issues
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ "${{ github.event.inputs.test_failure }}" == "true" ]]; then
          echo "âŒ Simulated deployment failure"
          exit 1
        fi
        
        echo "âœ… Application deployed successfully"
        echo "ğŸ”— Deployment URL: $DEPLOYMENT_URL"
        
    - name: Health check verification
      id: health_check
      shell: bash
      run: |
        echo "ğŸ¥ Verifying application health..."
        
        HEALTH_URL="${{ inputs.health_check_url }}"
        TIMEOUT_MINUTES="${{ inputs.timeout_minutes }}"
        TIMEOUT_SECONDS=$((TIMEOUT_MINUTES * 60))
        
        # Wait for application to be ready
        for i in $(seq 1 $TIMEOUT_SECONDS); do
          if curl -f -s "$HEALTH_URL" > /dev/null; then
            echo "âœ… Health check passed after ${i} seconds"
            echo "health_status=healthy" >> $GITHUB_OUTPUT
            break
          fi
          
          if [[ $i -eq $TIMEOUT_SECONDS ]]; then
            echo "âŒ Health check failed after $TIMEOUT_MINUTES minutes"
            echo "health_status=unhealthy" >> $GITHUB_OUTPUT
            
            if [[ "${{ inputs.rollback_on_failure }}" == "true" ]]; then
              echo "ğŸ”„ Initiating rollback..."
              exit 1
            fi
          fi
          
          sleep 1
        done
        
    - name: Run smoke tests
      shell: bash
      run: |
        echo "ğŸ§ª Running smoke tests..."
        
        # Basic connectivity test
        curl -f -s "${{ steps.deploy.outputs.deployment_url }}" > /dev/null
        echo "âœ… Connectivity test passed"
        
        # API endpoint test
        if [[ "${{ steps.deploy.outputs.deployment_url }}" == *"example.com"* ]]; then
          echo "âœ… API endpoints accessible (simulated)"
        fi
        
        echo "âœ… Smoke tests completed"
        
    - name: Send notification
      if: inputs.notification_webhook != ''
      shell: bash
      run: |
        echo "ğŸ“¬ Sending deployment notification..."
        
        PAYLOAD=$(cat <<EOF
        {
          "deployment_id": "${{ steps.deploy.outputs.deployment_id }}",
          "environment": "${{ inputs.environment }}",
          "status": "success",
          "url": "${{ steps.deploy.outputs.deployment_url }}",
          "commit": "${{ github.sha }}",
          "actor": "${{ github.actor }}",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF
        )
        
        # In a real scenario, you would send this to your notification webhook
        echo "ğŸ“¨ Notification payload:"
        echo "$PAYLOAD"
        
        echo "âœ… Notification sent"
        
    - name: Finalize deployment
      id: finalize
      shell: bash
      run: |
        echo "ğŸ¯ Finalizing deployment..."
        
        # Record deployment in registry (simulated)
        echo "ğŸ“ Recording deployment in registry..."
        
        # Set final status
        if [[ "${{ steps.health_check.outputs.health_status }}" == "healthy" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… Deployment completed successfully"
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "âŒ Deployment failed"
        fi
        
        # Deployment summary
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment ID**: ${{ steps.deploy.outputs.deployment_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: ${{ steps.deploy.outputs.deployment_url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ steps.health_check.outputs.health_status == 'healthy' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
        
    - name: Rollback on failure
      if: failure() && inputs.rollback_on_failure == 'true'
      shell: bash
      run: |
        echo "ğŸ”„ Initiating automatic rollback..."
        
        # Simulate rollback process
        echo "ğŸ“¦ Rolling back to previous version..."
        sleep 3
        
        # Verify rollback
        echo "ğŸ¥ Verifying rollback health..."
        sleep 2
        
        echo "âœ… Rollback completed successfully"
        
        # Update deployment status
        echo "ğŸ“ Updating deployment status to 'rolled_back'"
